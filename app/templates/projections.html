{% extends 'base.html' %}
{% block head %}
<style>
  .proj-toolbar{ display:flex; gap:10px; align-items:center; margin:0 0 16px 0; }
  .proj-toolbar button{ background:var(--panel-alt); border:1px solid #2a3142; color:var(--text); padding:8px 12px; font-size:14px; border-radius:8px; font-weight:600; cursor:pointer; }
  .proj-toolbar button.active{ background:var(--accent); border-color:var(--accent); }
  .odds-toggle button{ background:var(--panel-alt); border:1px solid #2a3142; color:var(--text); padding:6px 12px; font-size:13px; border-radius:8px; font-weight:600; cursor:pointer; }
  .odds-toggle button.active{ background:var(--accent); border-color:var(--accent); }
  .live-table{ width:100%; border-collapse:collapse; font-size:15px; table-layout:auto; }
  .live-table th{ text-align:center; font-size:12px; text-transform:uppercase; letter-spacing:.8px; padding:10px 8px; color:var(--text-dim); font-weight:700; border-bottom:1px solid #222b37; }
  .live-table td{ padding:10px 8px; border-bottom:1px solid #1a2230; word-break:break-word; }
  .live-table th.col-right, .live-table td.col-right{ text-align:right; }
  .live-table th.col-center, .live-table td.col-center{ text-align:center; }
  .live-table th.col-left, .live-table td.col-left{ text-align:left; }
  .team-cell{ display:flex; align-items:center; gap:10px; font-weight:650; }
  .team-cell.right{ justify-content:flex-end; }
  .team-cell img{ height:40px; width:40px; object-fit:contain; filter:drop-shadow(0 0 2px rgba(0,0,0,.6)); }
  .status-chip{ font-size:11px; font-weight:700; padding:2px 6px; border-radius:6px; background:#263145; color:#d7deea; }
  .win-bg{ transition:background 0.2s; }
  .bet-bg{ transition:background 0.2s; }
  .odds-input{ width:72px; text-align:center; font-size:15px; border-radius:6px; border:1px solid #2a3142; background:var(--panel-alt); color:var(--text); }
  .odds-input:focus{ outline:2px solid var(--accent); }
  .win-duo{ display:inline-flex; gap:6px; align-items:center; justify-content:center; }
  .win-chip{ display:inline-block; padding:6px 10px; border-radius:8px; min-width:68px; text-align:center; font-weight:700; font-size:16px; }
  .bet-chip{ display:inline-block; padding:6px 10px; border-radius:8px; min-width:68px; text-align:center; font-weight:700; font-size:16px; color:#0b0f16; }
  .lineup-btn{ background:transparent; border:1px solid #2a3142; color:var(--text); padding:6px 10px; border-radius:8px; font-weight:650; cursor:pointer; }
  .proj-title{ text-align:center; margin: 0 0 10px 0; font-size:18px; font-weight:750; color:var(--text); }
  /* Modal */
  .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:1000; }
  .modal{ background:#0f1522 !important; border:1px solid #2a3142; border-radius:12px; width:min(700px, 92vw); max-height:80vh; overflow:auto; box-shadow:0 8px 30px rgba(0,0,0,.5); }
  .modal header{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid #2a3142; }
  .modal h3{ margin:0; font-size:18px; font-weight:750; }
  .modal .body{ padding:12px 16px; background:#0f1522; }
  .modal .player-list{ display:flex; flex-direction:column; gap:8px; }
  .modal .footer{ display:flex; gap:10px; justify-content:flex-end; padding:12px 16px; border-top:1px solid #2a3142; background:#0f1522; }
  .btn{ background:var(--panel-alt); border:1px solid #2a3142; color:var(--text); padding:8px 12px; border-radius:8px; font-weight:650; cursor:pointer; }
  .btn.primary{ background:var(--accent); color:#0b1017; border-color:var(--accent); }
  .player-item{ display:grid; grid-template-columns: 1fr 360px; align-items:center; column-gap:10px; padding:6px 8px; border:1px solid transparent; border-radius:8px; }
  .player-item:hover{ background:rgba(255,255,255,0.03); border-color:#2a3142; }
  .player-item input{ transform:scale(1.15); }
  .player-meta{ display:flex; align-items:center; gap:8px; min-width:0; }
  .player-name{ font-weight:650; }
  .player-pos{ font-size:11px; color:var(--text-dim); padding:2px 6px; border:1px solid #2a3142; border-radius:6px; }
  .proj-stack{ display:flex; align-items:center; gap:8px; }
  .proj-bar{ position:relative; flex:1 1 auto; height:12px; max-height:12px; min-width:160px; background:#0e1726; border-radius:6px; overflow:hidden; border:1px solid #2a3142; display:flex; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08); }
  .proj-bar .half{ height:100%; display:flex; gap:0; flex:0 0 auto; }
  .proj-bar .seg{ height:100%; display:block; flex:0 0 auto; }
  .proj-bar .half.left{ flex-direction:row-reverse; }
  .proj-bar .zero{ position:absolute; left:50%; top:0; bottom:0; width:1px; background:#2a3142; opacity:0.9; }
  .seg-pos{ background:#4f6cf6; }
  .seg-neg{ background:#ff6a6a; }
  .proj-num{ font-size:12px; color:var(--text-dim); min-width:70px; text-align:right; }
</style>
{% endblock %}
{% block content %}
<div class="proj-toolbar">
  <button id="btnYesterday">Yesterday (ET)</button>
  <button id="btnToday" class="active">Today (ET)</button>
  <button id="btnTomorrow">Tomorrow (ET)</button>
  <div style="flex:1"></div>
  <div class="odds-toggle">
    <span style="margin-right:6px;color:var(--text-dim);font-size:12px;letter-spacing:.3px;">Odds:</span>
    <button id="oddsAmerican" class="active">American</button>
    <button id="oddsDecimal">Decimal</button>
  </div>
</div>
<h2 id="projDateTitle" class="proj-title"></h2>
<div id="projRoot"></div>

<!-- Lineups Modal -->
<div id="lineupModal" class="modal-backdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="lineupTitle">
    <header>
      <h3 id="lineupTitle">Edit Lineup</h3>
      <button class="btn" id="lineupClose">Close</button>
    </header>
    <div class="body">
      <div id="lineupTeamInfo" style="margin:0 0 8px 0; color:var(--text-dim);"></div>
      <div id="playerList" class="player-list"></div>
    </div>
    <div class="footer">
      <button class="btn" id="lineupCancel">Cancel</button>
      <button class="btn primary" id="lineupApply">Apply</button>
    </div>
  </div>
  
</div>
<script id="teams-data" type="application/json">{{ teams|tojson|safe }}</script>
{% endblock %}
{% block scripts %}
<script>
const root = document.getElementById('projRoot');
const btnToday = document.getElementById('btnToday');
const btnYesterday = document.getElementById('btnYesterday');
const btnTomorrow = document.getElementById('btnTomorrow');
const dateEl = document.getElementById('projDateTitle');
const oddsAmericanBtn = document.getElementById('oddsAmerican');
const oddsDecimalBtn = document.getElementById('oddsDecimal');
// Modal refs
const modalBackdrop = document.getElementById('lineupModal');
const modalClose = document.getElementById('lineupClose');
const modalCancel = document.getElementById('lineupCancel');
const modalApply = document.getElementById('lineupApply');
const playerListEl = document.getElementById('playerList');
const lineupTeamInfoEl = document.getElementById('lineupTeamInfo');

// Caches and overrides
window._lineupsCache = window._lineupsCache || null; // contents of lineups_all.json
window._rosterCache = window._rosterCache || {}; // { [TEAM]: roster json from /api/roster/<TEAM>/current }
window._currentGamesById = window._currentGamesById || {};
window._winOverrides = window._winOverrides || {}; // { [gameId]: { away: p, home: p } }
window._projCsvCache = window._projCsvCache || null; // { [playerId:number]: { pos: 'F'|'D'|'G', Age: num, Rookie: num, EVO: num, EVD: num, PP: num, SH: num, GSAx: num } }

let _dialogState = null; // { gameId, side, teamAbbrev, baselineCount }
let _currentWhich = 'today';

let oddsMode = 'american'; // 'american' | 'decimal'

function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

function hexToRgb(hex){
  try{
    let h = String(hex||'').trim();
    if(!h.startsWith('#')) return null;
    h = h.slice(1);
    if(h.length===3) h = h.split('').map(c=>c+c).join('');
    if(h.length!==6) return null;
    const r = parseInt(h.slice(0,2),16);
    const g = parseInt(h.slice(2,4),16);
    const b = parseInt(h.slice(4,6),16);
    if(!Number.isFinite(r)||!Number.isFinite(g)||!Number.isFinite(b)) return null;
    return {r,g,b};
  }catch(_){ return null; }
}

function mixHex(hexA, hexB, t){
  const a = hexToRgb(hexA);
  const b = hexToRgb(hexB);
  if(!a || !b) return hexA;
  const tt = clamp(Number(t)||0, 0, 1);
  const r = Math.round(a.r*(1-tt) + b.r*tt);
  const g = Math.round(a.g*(1-tt) + b.g*tt);
  const bb = Math.round(a.b*(1-tt) + b.b*tt);
  return `rgb(${r},${g},${bb})`;
}

function getTextColorForBg(bgColor){
  // Parse rgba/rgb string or hex, return appropriate text color
  const match = (bgColor||'').match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
  if(match){
    const r = parseInt(match[1], 10);
    const g = parseInt(match[2], 10);
    const b = parseInt(match[3], 10);
    const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
    return luminance > 0.5 ? '#000000' : '#ffffff';
  }
  // Try hex format
  let hex = String(bgColor||'').trim().replace('#', '');
  if(hex.length === 3) hex = hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
  if(hex.length === 6){
    const r = parseInt(hex.substring(0,2), 16);
    const g = parseInt(hex.substring(2,4), 16);
    const b = parseInt(hex.substring(4,6), 16);
    if(Number.isFinite(r) && Number.isFinite(g) && Number.isFinite(b)){
      const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
      return luminance > 0.5 ? '#000000' : '#ffffff';
    }
  }
  return '#ffffff';
}

function applyProjectionsTextColors(){
  // Match base.html slicer behavior: choose text color based on the team's base color.
  // Light-colored teams (e.g. BOS) => black text; most teams => white text.
  try{
    const panelAlt = (getComputedStyle(document.documentElement).getPropertyValue('--panel-alt').trim() || '#1c2233');
    const uiText = getTextColorForBg(panelAlt);
    const btns = [btnToday, btnYesterday, btnTomorrow, oddsAmericanBtn, oddsDecimalBtn].filter(Boolean);
    btns.forEach(btn=>{ btn.style.color = uiText; });
    // Inputs are re-rendered, but keep any existing ones consistent.
    document.querySelectorAll('.odds-input').forEach(inp=>{ try{ inp.style.color = uiText; }catch(_){/*ignore*/} });
  }catch(_){/* ignore */}
}

function themeAccent(){
  try{ return getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#4da3ff'; }catch(_){ return '#4da3ff'; }
}

function themeTextDim(){
  try{ return getComputedStyle(document.documentElement).getPropertyValue('--text-dim').trim() || '#9aa4b1'; }catch(_){ return '#9aa4b1'; }
}

// --- Odds helpers (American/Decimal) ---
function toDecimal(american){
  if(american==null || american==='') return null;
  const a = Number(american);
  if(!Number.isFinite(a)) return null;
  if(a > 0) return 1 + (a/100);
  if(a < 0) return 1 + (100/Math.abs(a));
  return null;
}

function toAmerican(decimal){
  if(decimal==null || decimal==='') return null;
  const d = Number(decimal);
  if(!Number.isFinite(d) || d <= 1) return null;
  if(d >= 2){
    return Math.round((d - 1) * 100);
  }
  return Math.round(-100 / (d - 1));
}

function parseAmerican(val){
  if(val==null) return null;
  const s = String(val).trim();
  if(!s) return null;
  // If it looks like a decimal (contains a dot or >=1.01 and < 10), convert to American
  const n = Number(s);
  if(Number.isFinite(n)){
    if(n >= 1.01 && n < 10) return toAmerican(n);
    // Already American-style number
    return Math.round(n);
  }
  // Fallback: try stripping + sign
  const s2 = s.replace(/^\+/,'');
  const n2 = Number(s2);
  if(Number.isFinite(n2)) return Math.round(n2);
  return null;
}

function renderPlayerItems(list, preselectIds){
  // Scale bars by global max positive/negative totals and skew zero accordingly
  let posMax = 0, negMaxAbs = 0;
  for(const p of list){
    const t = Number(p.total);
    if(!Number.isFinite(t)) continue;
    if(t > 0 && t > posMax) posMax = t;
    if(t < 0 && Math.abs(t) > negMaxAbs) negMaxAbs = Math.abs(t);
  }
  const denom = posMax + negMaxAbs;
  const leftPct = denom>0 ? (100 * (negMaxAbs/denom)) : 50;
  const rightPct = 100 - leftPct;
  const rows = list.map(p=>{
  const defaultChecked = preselectIds ? preselectIds.has(p.id) : ((p.pos==='F' || p.pos==='D') ? (String(p.unit||'').toUpperCase()!=='EXT') : (p.pos==='G' ? (String(p.unit||'').toUpperCase()==='G1') : false));
    const t = Number(p.total);
    const isPos = Number.isFinite(t) && t>0;
    const isNeg = Number.isFinite(t) && t<0;
    const posWidth = (isPos && posMax>0) ? (100 * (t/posMax)) : 0;
    const negWidth = (isNeg && negMaxAbs>0) ? (100 * (Math.abs(t)/negMaxAbs)) : 0;
  const negHtml = isNeg ? `<span class="seg seg-neg" style="width:${negWidth}%;"></span>` : '';
  const posHtml = isPos ? `<span class="seg seg-pos" style="width:${posWidth}%;"></span>` : '';
    const barHtml = `
      <span class="proj-bar">
        <span class="half left" style="width:${leftPct}%;">${negHtml}</span>
        <span class="half right" style="width:${rightPct}%;">${posHtml}</span>
        <span class="zero" style="left:${leftPct}%;"></span>
      </span>`;
    const totalStr = (p.total!=null) ? Number(p.total).toFixed(3) : 'n/a';
    return `<label class="player-item">
      <span class="player-meta"><input type="checkbox" data-id="${p.id??''}" data-name="${p.name.replace(/\"/g,'&quot;')}" data-pos="${p.pos}" data-unit="${p.unit||''}" ${defaultChecked?'checked':''}/> <span class="player-name">${p.name}</span> <span class="player-pos">${p.pos}${p.unit?` • ${p.unit}`:''}</span></span>
      <span class="proj-stack">${barHtml}<span class="proj-num">${totalStr}</span></span>
    </label>`;
  }).join('');
  playerListEl.innerHTML = rows;
}
  function winBgColor(percent){
    const p = Math.max(20, Math.min(80, percent));
    let r,g,b;
    if(p <= 50){
      const t = p/50;
      r = Math.round(255*(1-t) + 255*t);
      g = Math.round(77*(1-t) + 255*t);
      b = Math.round(77*(1-t) + 255*t);
    }else{
      const t = (p-50)/50;
      r = Math.round(255*(1-t) + 77*t);
      g = Math.round(255*(1-t) + 163*t);
      b = Math.round(255*(1-t) + 255*t);
    }
    return `rgba(${r},${g},${b},0.85)`;
  }
  function betBgColor(val){
    const v = Math.max(0, Math.min(0.1, val||0));
    const t = v / 0.1;
    const r = Math.round(255*(1-t) + 77*t);
    const g = Math.round(255*(1-t) + 163*t);
    const b = Math.round(255*(1-t) + 255*t);
    const a = 0.85;
    return `rgba(${r},${g},${b},${a})`;
  }

  // 0.3 Kelly fraction based on win probability and American moneyline
  function kelly03(prob, american){
    if(prob==null || american==null) return null;
    const p = Number(prob);
    if(!(p>=0 && p<=1)) return null;
    const dec = toDecimal(american);
    if(dec==null) return null;
    const b = dec - 1;
    if(!(b>0)) return null;
    const q = 1 - p;
    const f = (b*p - q) / b;
    const fScaled = 0.3 * f;
    if(!(fScaled>0)) return null;
    return fScaled;
  }

function renderTable(games){
  if(!games || !games.length){ root.innerHTML = '<div class="live-empty">No games.</div>'; return; }
  const panelAlt = (getComputedStyle(document.documentElement).getPropertyValue('--panel-alt').trim() || '#1c2233');
  const inputTextColor = getTextColorForBg(panelAlt);
  const header = `<thead><tr>
    <th class="col-center">Time</th>
    <th class="col-center">Lineups</th>
    <th class="col-center">Bet%</th>
    <th class="col-center">Odds</th>
    <th class="col-center">Away</th>
    <th class="col-center">Win%</th>
    <th class="col-center">Home</th>
    <th class="col-center">Odds</th>
    <th class="col-center">Bet%</th>
    <th class="col-center">Lineups</th>
  </tr></thead>`;
  window._oddsOverrides = window._oddsOverrides || {};
  const rows = games.map(g=>{
    const h = g.homeTeam||{}; const a = g.awayTeam||{};
    const p = g.projections||{};
    const t = g.startTimeET? new Date(g.startTimeET) : null;
    const timeStr = (t && !isNaN(t)) ? t.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
    const awayCell = `<div class="team-cell right">${a.abbrev||''} <img src="${a.logo||''}" alt="${a.abbrev||''}"/></div>`;
    const homeCell = `<div class="team-cell"><img src="${h.logo||''}" alt="${h.abbrev||''}"/> ${h.abbrev||''}</div>`;
  // Prefer prestart values for started games
  const started = g.started === true;
  const pre = g.prestart || null;
  const pAwayBase = started && pre && pre.winAwayPct!=null ? (Number(pre.winAwayPct)/100) : ((p.winProbAway!=null) ? Number(p.winProbAway) : null);
  const pHomeBase = started && pre && pre.winHomePct!=null ? (Number(pre.winHomePct)/100) : ((p.winProbHome!=null) ? Number(p.winProbHome) : null);
    const over = window._winOverrides[g.id];
    const pAway = over?.away ?? pAwayBase;
    const pHome = over?.home ?? pHomeBase;
    const winA = (pAway!=null) ? (pAway*100).toFixed(1)+'%' : '';
    const winH = (pHome!=null) ? (pHome*100).toFixed(1)+'%' : '';
  const baseOddsA = started && pre && pre.oddsAway!=null ? parseAmerican(pre.oddsAway) : parseAmerican(g?.odds?.away);
  const baseOddsH = started && pre && pre.oddsHome!=null ? parseAmerican(pre.oddsHome) : parseAmerican(g?.odds?.home);
  const rawOddsA = started ? baseOddsA : (window._oddsOverrides[g.id]?.away ?? baseOddsA);
  const rawOddsH = started ? baseOddsH : (window._oddsOverrides[g.id]?.home ?? baseOddsH);
    const displayOddsA = (oddsMode==='american') ? (rawOddsA ?? '') : (rawOddsA!=null ? toDecimal(rawOddsA).toFixed(2) : '');
    const displayOddsH = (oddsMode==='american') ? (rawOddsH ?? '') : (rawOddsH!=null ? toDecimal(rawOddsH).toFixed(2) : '');
  const betA = started && pre && pre.betAwayPct!=null ? (Number(pre.betAwayPct)/100) : kelly03(pAway, rawOddsA);
  const betH = started && pre && pre.betHomePct!=null ? (Number(pre.betHomePct)/100) : kelly03(pHome, rawOddsH);
    const winAVal = (p.winProbAway!=null) ? (p.winProbAway*100) : null;
    const winHVal = (p.winProbHome!=null) ? (p.winProbHome*100) : null;
    const winBgA = winAVal!=null ? winBgColor(winAVal) : '';
    const winBgH = winHVal!=null ? winBgColor(winHVal) : '';
    const betBgA = betA!=null ? betBgColor(betA) : '';
    const betBgH = betH!=null ? betBgColor(betH) : '';
    const step = (oddsMode==='american') ? '1' : '0.01';
    const minAttr = (oddsMode==='american') ? '' : ' min="1.01"';
  const disAttr = started ? ' disabled' : '';
  const oddsAInput = `<input class="odds-input" style="color:${inputTextColor};" type="number" step="${step}"${minAttr} value="${displayOddsA}" data-game="${g.id}" data-side="away"${disAttr} />`;
  const oddsHInput = `<input class="odds-input" style="color:${inputTextColor};" type="number" step="${step}"${minAttr} value="${displayOddsH}" data-game="${g.id}" data-side="home"${disAttr} />`;
    return `<tr class="proj-row" data-href="/odds/${g.id}" style="cursor:pointer;">
      <td class="col-center">${timeStr}</td>
      <td class="col-center"><button class="lineup-btn" data-game="${g.id}" data-side="away" data-team="${a.abbrev||''}">Edit</button></td>
      <td class="col-center">${betA!=null ? `<span class="bet-chip" style="background:${betBgA}; color:${getTextColorForBg(betBgA)}">${(betA*100).toFixed(1)}%</span>` : ''}</td>
      <td class="col-center">${oddsAInput}</td>
      <td class="col-right">${awayCell}</td>
      <td class="col-center">
        <div class="win-duo">
          <span class="win-chip" style="background:${winBgA}; color:${getTextColorForBg(winBgA)}">${winA}</span>
          <span class="win-chip" style="background:${winBgH}; color:${getTextColorForBg(winBgH)}">${winH}</span>
        </div>
      </td>
      <td class="col-left">${homeCell}</td>
      <td class="col-center">${oddsHInput}</td>
      <td class="col-center">${betH!=null ? `<span class="bet-chip" style="background:${betBgH}; color:${getTextColorForBg(betBgH)}">${(betH*100).toFixed(1)}%</span>` : ''}</td>
      <td class="col-center"><button class="lineup-btn" data-game="${g.id}" data-side="home" data-team="${h.abbrev||''}">Edit</button></td>
    </tr>`;
  }).join('');
  root.innerHTML = `<table class="live-table">${header}<tbody>${rows}</tbody></table>`;
  root.querySelectorAll('.proj-row').forEach(tr=>{
    tr.addEventListener('click', (e)=>{
      const t = e && e.target ? e.target : null;
      // Don't navigate when interacting with controls inside the row
      if(t && (t.closest('button') || t.closest('input') || t.closest('select') || t.closest('label') || t.closest('a'))) return;
      const href = tr.getAttribute('data-href');
      if(href) window.location.href = href;
    });
  });
  root.querySelectorAll('.odds-input').forEach(inp=>{
    inp.addEventListener('change', e=>{
      const gameId = inp.getAttribute('data-game');
      const side = inp.getAttribute('data-side');
      const val = inp.value;
      if(!gameId || !side) return;
      window._oddsOverrides[gameId] = window._oddsOverrides[gameId] || {};
      const num = Number(val);
      let americanVal = null;
      if(oddsMode === 'decimal'){
        americanVal = toAmerican(num);
      }else{
        americanVal = parseAmerican(num);
      }
      window._oddsOverrides[gameId][side] = americanVal;
      renderTable(games);
    });
  });
  root.querySelectorAll('.lineup-btn').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const gameId = btn.getAttribute('data-game');
      const side = btn.getAttribute('data-side');
      const team = btn.getAttribute('data-team');
      if(!gameId || !side || !team) return;
      await openLineupDialog(gameId, side, team);
    });
  });
}

function setActiveWhich(which){
  _currentWhich = which;
  btnToday.classList.toggle('active', which==='today');
  btnYesterday.classList.toggle('active', which==='yesterday');
  btnTomorrow.classList.toggle('active', which==='tomorrow');
  applyProjectionsTextColors();
}

btnToday.addEventListener('click', ()=>{ setActiveWhich('today'); loadGames('today'); });
btnYesterday.addEventListener('click', ()=>{ setActiveWhich('yesterday'); loadGames('yesterday'); });
btnTomorrow.addEventListener('click', ()=>{ setActiveWhich('tomorrow'); loadGames('tomorrow'); });

// Restore preferred odds mode
const savedMode = localStorage.getItem('oddsMode');
if(savedMode === 'decimal' || savedMode === 'american'){
  oddsMode = savedMode;
  if(oddsMode==='decimal'){
    oddsDecimalBtn.classList.add('active');
    oddsAmericanBtn.classList.remove('active');
  }else{
    oddsAmericanBtn.classList.add('active');
    oddsDecimalBtn.classList.remove('active');
  }
}
// Apply text color to active odds buttons on page load
applyProjectionsTextColors();

// Load games and render table (restored helper)
async function loadGames(which='today'){
  try{
    root.innerHTML = '<div class="live-empty">Loading…</div>';
    const r = await fetch(`/api/projections/games?which=${encodeURIComponent(which)}`);
    const js = await r.json();
    dateEl.textContent = js.date || '';
    const games = js.games||[];
    window._currentGamesById = Object.fromEntries((games||[]).map(g=>[g.id, g]));
    try{
      renderTable(games);
    }catch(err){
      console.error('[renderTable] failed:', err);
      root.innerHTML = '<div class="game-card"><div>Error loading games</div></div>';
    }
  }catch(e){ console.error('[loadGames] failed:', e); root.innerHTML = '<div class="game-card"><div>Error loading games</div></div>'; }
}

oddsAmericanBtn?.addEventListener('click', ()=>{
  oddsMode = 'american';
  localStorage.setItem('oddsMode', oddsMode);
  oddsAmericanBtn.classList.add('active');
  oddsDecimalBtn.classList.remove('active');
  applyProjectionsTextColors();
  loadGames(_currentWhich);
});
oddsDecimalBtn?.addEventListener('click', ()=>{
  oddsMode = 'decimal';
  localStorage.setItem('oddsMode', oddsMode);
  oddsDecimalBtn.classList.add('active');
  oddsAmericanBtn.classList.remove('active');
  applyProjectionsTextColors();
  loadGames(_currentWhich);
});

setActiveWhich('today');
loadGames('today');
applyProjectionsTextColors();

// Re-apply after team theme changes (base.html sets CSS vars on teamSelect change)
teamSelect?.addEventListener('change', ()=>{
  // Defer to allow base.html setTheme() to run first.
  setTimeout(()=>{
    applyProjectionsTextColors();
  }, 0);
});

// ------- Lineups dialog + Win% adjustment -------
async function ensureLineupsCache(){
  if(window._lineupsCache) return window._lineupsCache;
  try{
    const r = await fetch('/api/lineups/all', { cache:'no-store' });
    if(r.ok){
      window._lineupsCache = await r.json();
      try{ console.log('[lineups] loaded keys:', Object.keys(window._lineupsCache||{}).length); }catch(_){/* noop */}
    }else{
      let detail = null;
      try{ detail = await r.json(); }catch(_){ detail = null; }
      try{ console.error('[lineups] failed:', r.status, detail || '(no json)'); }catch(_){/* noop */}
    }
  }catch(e){ /* ignore */ }
  return window._lineupsCache;
}

async function ensureRosterCache(teamAbbrev){
  const t = String(teamAbbrev||'').toUpperCase();
  if(!t) return null;
  if(window._rosterCache && window._rosterCache[t]) return window._rosterCache[t];
  try{
    const r = await fetch(`/api/roster/${encodeURIComponent(t)}/current`, { cache:'no-store' });
    if(!r.ok) return null;
    const js = await r.json();
    window._rosterCache = window._rosterCache || {};
    window._rosterCache[t] = js;
    return js;
  }catch(_){
    return null;
  }
}

async function ensureProjectionsCsv(){
  if(window._projCsvCache) return window._projCsvCache;
  try{
    const r = await fetch('/api/player-projections/sheets', { cache:'no-store' });
    if(!r.ok) return null;
    const data = await r.json();
    if(!data || typeof data !== 'object') return null;
    // Helper to parse numbers with comma decimal separator (like RAPM does)
    const parseLocaleNumber = (val) => {
      if(val == null || val === '') return 0;
      if(typeof val === 'number') return val;
      const s = String(val).trim().replace(',', '.');
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    };
    // Convert from { playerId: { PlayerID, Position, Age, ... }, ... } to same format
    const map = {};
    for(const [id, row] of Object.entries(data)){
      const pid = Number(id);
      if(!pid) continue;
      const pos = String(row.Position || row.Pos || '').trim().toUpperCase();
      const getNum = (k) => parseLocaleNumber(row[k]);
      map[pid] = {
        pos: (pos||'F')[0],
        Age: getNum('Age'), Rookie: getNum('Rookie'), EVO: getNum('EVO'), EVD: getNum('EVD'), PP: getNum('PP'), SH: getNum('SH'), GSAx: getNum('GSAx')
      };
    }
    window._projCsvCache = map;
    try{ console.log('[projections] Sheets3 loaded:', Object.keys(map).length, 'players'); }catch(_){/* ignore */}
    return map;
  }catch(e){ 
    console.error('[projections] Failed to load from Sheets3:', e);
    return null; 
  }
}

function extractPlayerName(p){
  if(!p) return '';
  // Attempt to support API variations
  if(p.firstName && p.lastName){
    const fn = typeof p.firstName === 'object' ? (p.firstName.default || Object.values(p.firstName)[0] || '') : p.firstName;
    const ln = typeof p.lastName === 'object' ? (p.lastName.default || Object.values(p.lastName)[0] || '') : p.lastName;
    return `${fn} ${ln}`.trim();
  }
  return p.fullName || p.person?.fullName || p.name || '';
}

function getTeamLineup(teamAbbrev){
  const cache = window._lineupsCache || {};
  return cache?.[String(teamAbbrev||'').toUpperCase()] || {};
}

function getTeamUpdatedAt(teamAbbrev){
  const cache = window._lineupsCache || {};
  const info = cache?.[String(teamAbbrev||'').toUpperCase()] || {};
  const iso = info.generated_at || info.generatedAt || null;
  if(!iso) return '';
  try{
    const d = new Date(String(iso).replace('Z','+00:00'));
    if(isNaN(d)) return String(iso);
    return d.toLocaleString();
  }catch(_){ return String(iso); }
}

function playerIdOf(p){
  if(!p) return null;
  const tryFields = [p.playerId, p.id, p.personId, p.person?.id, p.person?.link?.split('/')?.pop?.()];
  for(const t of tryFields){ const n = Number(t); if(Number.isInteger(n) && n>0) return n; }
  return null;
}

function posOf(p){
  const raw = (p.pos || p.position || p.primaryPosition?.type || p.primaryPosition?.abbreviation || '').toString().toUpperCase();
  if(raw.startsWith('F') || raw==='C' || raw==='LW' || raw==='RW') return 'F';
  if(raw.startsWith('D')) return 'D';
  if(raw.startsWith('G')) return 'G';
  return 'F';
}

function unitOf(p){
  return (p.unit||'').toString().toUpperCase();
}

function projValueFromMetrics(m){
  if(!m) return 0;
  return (m.Age||0)+(m.Rookie||0)+(m.EVO||0)+(m.EVD||0)+(m.PP||0)+(m.SH||0)+(m.GSAx||0);
}

function buildPlayerList(teamAbbrev, projMap, roster){
  // Base list from Sheets lineups; then append missing roster players as EXT.
  const lu = getTeamLineup(teamAbbrev);
  const goalies = [];
  const forwards = [];
  const defense = [];
  const pushItem = (arr, it, posCode)=>{
    const id0 = (Number(it.playerId)||null);
    const name = String(it.name||'');
    const unit = String(it.unit||'').toUpperCase();
    const pos = posCode;
    const metrics = (id0 && projMap) ? projMap[id0] : null;
    const total = metrics ? projValueFromMetrics(metrics) : null;
    arr.push({ id: id0, name, pos, unit, metrics, total });
  };
  // Keep original order from lineup; no re-sort to preserve lines/pairs
  for(const it of (lu.goalies||[])) pushItem(goalies, it, 'G');
  for(const it of (lu.forwards||[])) pushItem(forwards, it, 'F');
  for(const it of (lu.defense||[])) pushItem(defense, it, 'D');

  const existingIds = new Set();
  for(const p of [...goalies, ...forwards, ...defense]){
    if(p.id) existingIds.add(Number(p.id));
  }

  const pushExt = (arr, r, posCode)=>{
    const id0 = playerIdOf(r);
    if(!id0 || existingIds.has(id0)) return;
    const name = extractPlayerName(r);
    if(!name) return;
    existingIds.add(id0);
    const metrics = (id0 && projMap) ? projMap[id0] : null;
    const total = metrics ? projValueFromMetrics(metrics) : null;
    arr.push({ id: id0, name, pos: posCode, unit: 'EXT', metrics, total });
  };

  if(roster){
    for(const r of (roster.goalies||[])) pushExt(goalies, r, 'G');
    for(const r of (roster.forwards||[])) pushExt(forwards, r, 'F');
    for(const r of (roster.defensemen||[])) pushExt(defense, r, 'D');
  }

  return [...goalies, ...forwards, ...defense];
}

function clearModal(){
  playerListEl.innerHTML = '';
  lineupTeamInfoEl.textContent = '';
}

async function openLineupDialog(gameId, side, teamAbbrev){
  clearModal();
  const [_, projMap, roster] = await Promise.all([
    ensureLineupsCache(), ensureProjectionsCsv(), ensureRosterCache(teamAbbrev)
  ]);
  const list = buildPlayerList(teamAbbrev, projMap||{}, roster||null);
  try{ console.log('[modal] open for', teamAbbrev, 'players:', list.length); }catch(_){/* noop */}
  const updated = getTeamUpdatedAt(teamAbbrev);
  lineupTeamInfoEl.textContent = `${teamAbbrev} — Select lineup (Lineup from DailyFaceoff preselected - Updated: ${updated})`;
  // Preselect from any saved selection for this game/side
  window._lineupSelections = window._lineupSelections || {};
  const saved = window._lineupSelections[gameId]?.[side] || null;
  const preIds = saved ? new Set(saved.map(s=>Number(s.id)||null).filter(Boolean)) : null;
  renderPlayerItems(list, preIds);
  _dialogState = { gameId, side, teamAbbrev, baselineCount: null, rosterCount: list.length };
  modalBackdrop.style.display = 'flex';
}

function closeLineupDialog(){
  modalBackdrop.style.display = 'none';
  _dialogState = null;
  clearModal();
}

modalClose?.addEventListener('click', (e)=>{ e.stopPropagation(); closeLineupDialog(); });
modalCancel?.addEventListener('click', (e)=>{ e.stopPropagation(); closeLineupDialog(); });
modalBackdrop?.addEventListener('click', (e)=>{
  if(e.target === modalBackdrop) closeLineupDialog();
});

modalApply?.addEventListener('click', (e)=>{
  e.stopPropagation();
  if(!_dialogState) return;
  const { gameId, side } = _dialogState;
  const checks = [...playerListEl.querySelectorAll('input[type="checkbox"]')];
  // Build selection per pos; for goalies include only one (prefer unit G1 if selected)
  const sel = checks.filter(c=>c.checked).map(c=>({
    id: Number(c.getAttribute('data-id'))||null,
    name: c.getAttribute('data-name')||'',
    pos: c.getAttribute('data-pos')||'F',
    unit: (c.getAttribute('data-unit')||'').toUpperCase()
  }));
  // Save selection until page refresh
  window._lineupSelections = window._lineupSelections || {};
  window._lineupSelections[gameId] = window._lineupSelections[gameId] || {};
  window._lineupSelections[gameId][side] = sel;
  recomputeWinWithSelection(gameId, side, sel);
  closeLineupDialog();
});

function adjustWinForSelection(gameId, side, ratioDelta){
  const g = window._currentGamesById[gameId];
  if(!g || !g.projections) return;
  const pA0 = Number(g.projections.winProbAway);
  const pH0 = Number(g.projections.winProbHome);
  if(!(pA0>0 && pA0<1 && pH0>0 && pH0<1)) return;
  const K = 1.0; // sensitivity factor
  const clamp = (x,min,max)=>Math.max(min,Math.min(max,x));
  const logit = p=>Math.log(p/(1-p));
  const invlogit = z=>1/(1+Math.exp(-z));
  let zA = logit(pA0);
  let zH = logit(pH0);
  const delta = clamp(ratioDelta, -0.5, 0.5) * K; // bound influence
  if(side==='away'){
    zA = zA + delta;
  }else{
    zH = zH + delta;
  }
  let pA = invlogit(zA);
  let pH = invlogit(zH);
  // Normalize to sum to 1
  const s = pA + pH;
  pA = pA / s; pH = pH / s;
  window._winOverrides[gameId] = { away: pA, home: pH };
  // Re-render with current table games when available
  const tableGames = Object.values(window._currentGamesById);
  renderTable(tableGames);
}

function recomputeWinWithSelection(gameId, side, selected){
  const g = window._currentGamesById[gameId];
  if(!g || !g.projections) return;
  const projBaseAway = Number(g.projections.projAway) || 0;
  const projBaseHome = Number(g.projections.projHome) || 0;
  const sVal = Number(g.projections.situationValue) || 0;
  const team = side==='away' ? (g.awayTeam?.abbrev||'') : (g.homeTeam?.abbrev||'');
  const projMap = window._projCsvCache || {};
  const ROOKIE_FALLBACK = { 'D': -0.031768511, 'F': -0.024601581, 'G': -0.12 };
  const sumTeam = ()=>{
    let total = 0;
    // Non-goalies: sum all
    for(const p of selected){
      const POS = (p.pos||'F').toUpperCase()[0];
      if(POS==='G') continue;
      const m = (p.id && projMap[p.id]) ? projMap[p.id] : null;
      if(m) total += projValueFromMetrics(m); else total += (ROOKIE_FALLBACK[POS] ?? ROOKIE_FALLBACK['F']);
    }
    // Goalies: include only one, prefer unit G1
    const goalies = selected.filter(p=> (p.pos||'F').toUpperCase().startsWith('G'));
    let gPick = goalies.find(p=> String(p.unit||'').toUpperCase()==='G1') || goalies[0] || null;
    if(gPick){
      const m = (gPick.id && projMap[gPick.id]) ? projMap[gPick.id] : null;
      const gValue = m ? projValueFromMetrics(m) : ROOKIE_FALLBACK['G'];
      console.log('[recompute] Selected goalie:', gPick.name, 'ID:', gPick.id, 'Metrics:', m, 'Value:', gValue);
      total += gValue;
    }
    return total;
  };
  const teamSum = sumTeam();
  let projAway = projBaseAway;
  let projHome = projBaseHome;
  if(side==='away') projAway = teamSum; else projHome = teamSum;
  const dproj = projAway - projHome;
  const winAway = 1.0/(1.0 + Math.exp(-(dproj) - sVal));
  const winHome = 1.0 - winAway;
  console.log('[recompute]', side, 'team:', team, '| TeamSum:', teamSum.toFixed(3), '| ProjAway:', projAway.toFixed(3), '| ProjHome:', projHome.toFixed(3), '| dProj:', dproj.toFixed(3), '| WinAway:', (winAway*100).toFixed(1) + '%');
  window._winOverrides[gameId] = { away: winAway, home: winHome };
  const tableGames = Object.values(window._currentGamesById);
  renderTable(tableGames);
}
</script>
{% endblock %}
