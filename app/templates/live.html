{% extends 'base.html' %}
{% block head %}
<style>

.live-wrapper{ width:100%; margin:0; display:flex; flex-direction:column; gap:16px; align-items:stretch; }
.live-header{ display:flex; align-items:center; justify-content:space-between; width:100%; }
.live-table{ width:100%; border-collapse:collapse; font-size:15px; table-layout:auto; }
.live-table th{ text-align:center; font-size:12px; text-transform:uppercase; letter-spacing:.8px; padding:10px 8px; color:var(--text-dim); font-weight:700; border-bottom:1px solid #222b37; }
.live-table td{ padding:10px 8px; border-bottom:1px solid #1a2230; word-break:break-word; }
.live-table th.col-right, .live-table td.col-right{ text-align:right; }
.live-table th.col-center, .live-table td.col-center{ text-align:center; }
.live-table th.col-left, .live-table td.col-left{ text-align:left; }
.live-empty{ color:var(--text-dim); font-size:14px; padding:16px; }
.team-cell{ display:flex; align-items:center; gap:10px; font-weight:650; }
.team-cell.right{ justify-content:flex-end; }
.team-cell img{ height:40px; width:40px; object-fit:contain; filter:drop-shadow(0 0 2px rgba(0,0,0,.6)); }
.team-name{ display:inline; }

@media (max-width: 980px){
  .live-table{ font-size:12px; }
  .live-table th{ font-size:10px; padding:8px 6px; }
  .live-table td{ padding:8px 6px; }
  .team-cell img{ height:28px; width:28px; }
}
.status-chip{ font-size:11px; font-weight:700; padding:2px 6px; border-radius:6px; background:#263145; color:#d7deea; }
/* limit link styling to anchors only to avoid breaking <tr> */
a.link-row{ color:var(--text); text-decoration:none; display:block; }
/* make table rows clearly clickable */
.live-table tbody tr{ cursor:pointer; }
tbody tr:hover{ background:#141c28; }
</style>
{% endblock %}
{% block content %}
<div class="live-wrapper">
  <div class="live-header">
    <h2 style="margin:0;">Live Games</h2>
    <span id="lastUpdated" style="font-size:14px; color:var(--text-dim);"></span>
  </div>
  <div id="liveRoot" class="panel"></div>
</div>
<script id="teams-data" type="application/json">{{ teams|tojson|safe }}</script>
{% endblock %}
{% block scripts %}
<script>
const liveRoot = document.getElementById('liveRoot');
const teamsData = JSON.parse(document.getElementById('teams-data').textContent||'[]');
function teamLogo(abbrev){ const row = teamsData.find(t=> t.Team===abbrev); return row?.Logo || `https://assets.nhle.com/logos/nhl/svg/${abbrev}_light.svg`; }
function fmtTime(iso){ try{ return new Date(iso).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }catch(e){ return iso; } }
function isMobile(){ try{ return window.matchMedia && window.matchMedia('(max-width: 980px)').matches; }catch(_){ return false; } }
function renderRows(games){
  if(!games || games.length===0){
    liveRoot.innerHTML = `<div class="live-empty">No live games right now.</div>`;
    return;
  }
  const mobile = isMobile();
  const header = mobile ? `<thead><tr>
    <th class="col-center">Period</th>
    <th class="col-center">Time Remaining</th>
    <th class="col-center">Away</th>
    <th class="col-center">Score</th>
    <th class="col-center">Home</th>
  </tr></thead>` : `<thead><tr>
    <th class="col-center">Period</th>
    <th class="col-center">Time Remaining</th>
    <th class="col-center">Intermission</th>
    <th class="col-center">SOG (Away)</th>
    <th class="col-center">Away</th>
    <th class="col-center">Score</th>
    <th class="col-center">Home</th>
    <th class="col-center">SOG (Home)</th>
    <th class="col-center">Venue</th>
  </tr></thead>`;
  const rows = games.map(g=>{
    const away = g.awayTeam||{}; const home = g.homeTeam||{};
    const score = (away.score!=null || home.score!=null) ? `${away.score??''} - ${home.score??''}` : '';
    const venue = (g.venue&&g.venue.default)||'';
    const link = `/game/${g.id}`;
    // Boxscore fields
    const period = g.periodDescriptor?.number ?? '';
  const timeRem = g.clock?.timeRemaining ?? '';
  const intermission = (g.clock?.isIntermission ?? g.clock?.inIntermission) ? 'Yes' : 'No';
    const sogAway = away.sog ?? '';
    const sogHome = home.sog ?? '';
    const awayCellDesktop = (()=>{
      const awayName = `${away.placeName?.default||''} ${away.commonName?.default||away.abbrev||''}`.trim();
      return `<div class=\"team-cell right\"><span class=\"team-name\">${awayName}</span> <img src=\"${teamLogo(away.abbrev)}\" alt=\"${away.abbrev||''}\"/></div>`;
    })();
    const homeCellDesktop = (()=>{
      const homeName = `${home.placeName?.default||''} ${home.commonName?.default||home.abbrev||''}`.trim();
      return `<div class=\"team-cell\"><img src=\"${teamLogo(home.abbrev)}\" alt=\"${home.abbrev||''}\"/> <span class=\"team-name\">${homeName}</span></div>`;
    })();
    const awayCellMobile = `<div class=\"team-cell right\"><img src=\"${teamLogo(away.abbrev)}\" alt=\"${away.abbrev||''}\"/></div>`;
    const homeCellMobile = `<div class=\"team-cell\"><img src=\"${teamLogo(home.abbrev)}\" alt=\"${home.abbrev||''}\"/></div>`;

    if(mobile){
      return `
        <tr onclick=\"window.location='${link}'\">
          <td class="col-center">${period}</td>
          <td class="col-center">${timeRem}</td>
          <td class="col-center">${awayCellMobile}</td>
          <td class="col-center">${score}</td>
          <td class="col-center">${homeCellMobile}</td>
        </tr>
      `;
    }

    return `
      <tr onclick=\"window.location='${link}'\">
        <td class="col-center">${period}</td>
        <td class="col-center">${timeRem}</td>
        <td class="col-center">${intermission}</td>
        <td class="col-center">${sogAway}</td>
        <td class="col-right">${awayCellDesktop}</td>
        <td class="col-center">${score}</td>
        <td class="col-left">${homeCellDesktop}</td>
        <td class="col-center">${sogHome}</td>
        <td class="col-center">${venue}</td>
      </tr>
    `;
  }).join('');
  liveRoot.innerHTML = `<table class="live-table">${header}<tbody>${rows}</tbody></table>`;
}
async function loadLive(forceBoxscore = false){
  try{
    const r = await fetch('/api/live-games');
    const js = await r.json();
    document.getElementById('lastUpdated').textContent = `Updated ${new Date().toLocaleTimeString()}`;
    if(Array.isArray(js.games)){
      const games = js.games;
      // Always fetch fresh boxscore data for each game
      const enriched = await Promise.all(games.map(async (g)=>{
        try{
          const br = await fetch(`/api/game/${g.id}/boxscore?force=1`);
          if(!br.ok) return g;
          const bs = await br.json();
          const merged = { ...g };
          if(bs && typeof bs === 'object'){
            if(bs.clock){ merged.clock = bs.clock; }
            if(bs.periodDescriptor){ merged.periodDescriptor = bs.periodDescriptor; }
            if(bs.awayTeam){ merged.awayTeam = { ...(g.awayTeam||{}), sog: bs.awayTeam.sog } }
            if(bs.homeTeam){ merged.homeTeam = { ...(g.homeTeam||{}), sog: bs.homeTeam.sog } }
            if(bs.venue){ merged.venue = bs.venue; }
          }
          return merged;
        }catch(e){ return g; }
      }));
      renderRows(enriched);
    } else {
      renderRows([]);
    }
  }catch(e){ renderRows([]); }
}
// Always fetch fresh boxscore data on page load
window.addEventListener('DOMContentLoaded', () => { loadLive(true); });
// Optional: auto-refresh every 30 seconds
setInterval(() => loadLive(true), 30000);
</script>
{% endblock %}
