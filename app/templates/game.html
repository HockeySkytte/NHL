{% extends 'game_base.html' %}
{% block head %}
<style>
.game-header { margin-bottom:24px; }
.game-header h2 { margin:0 0 6px; font-size:30px; letter-spacing:.6px; font-weight:650; }
.subline, .final-line { font-size:14px; opacity:.85; font-weight:500; }
.game-tabs { display:flex; gap:38px; border-bottom:1px solid #1f2734; margin-bottom:24px; }
.game-tabs button { background:none; border:none; font-size:14px; font-weight:600; padding:14px 4px 16px; cursor:pointer; position:relative; color:var(--text-dim); letter-spacing:.7px; }
.game-tabs button.active { color:var(--text); }
.game-tabs button.active::after { content:""; position:absolute; left:0; right:0; bottom:0; height:4px; background:var(--accent); border-radius:4px; box-shadow:0 0 8px -1px var(--accent); }
.panel { background:var(--panel); border:1px solid #222c3a; border-radius:14px; padding:24px 26px 30px; box-shadow:0 4px 18px -6px rgba(0,0,0,.55); }
.split { display:grid; gap:26px; }
@media (min-width:1100px){ .split { grid-template-columns:1fr 1fr; } }
.roster-group { margin-bottom:28px; }
.roster-group h3 { margin:0 0 14px; font-size:15px; letter-spacing:.8px; text-transform:uppercase; color:var(--text-dim); }
.player-cards { display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:20px; }
.player-card { background:var(--team-card-bg,rgba(255,255,255,.08)); border:1px solid rgba(255,255,255,.10); border-radius:16px; padding:16px 18px 18px; font-size:13px; line-height:1.28; position:relative; display:grid; grid-template-columns:94px 1fr; gap:16px; backdrop-filter:blur(4px); }
.player-card h4 { margin:0 0 6px; font-size:16px; font-weight:600; letter-spacing:.4px; }
.player-card .meta { font-size:12px; opacity:.9; letter-spacing:.4px; font-weight:500; }
.player-card img { width:94px; height:94px; border-radius:14px; object-fit:cover; background:#0d1117; box-shadow:0 2px 6px -2px rgba(0,0,0,.7),0 0 0 1px rgba(255,255,255,.10); }
.table { width:100%; border-collapse:collapse; font-size:13px; }
.table th { text-align:left; padding:8px 10px; font-size:11px; text-transform:uppercase; letter-spacing:.7px; border-bottom:1px solid #253041; color:var(--text-dim); }
.table td { padding:8px 10px; border-bottom:1px solid #1e2735; }
.skaters-table table th, .skaters-table table td { text-align:center; }
.skaters-table table th:first-child, .skaters-table table td:first-child { text-align:left; }
.val-chip { display:inline-block; padding:2px 6px; border-radius:8px; font-weight:800; min-width:44px; text-align:center; }
.badge { background:#253143; padding:2px 6px; border-radius:6px; font-size:11px; font-weight:600; letter-spacing:.5px; }
.sticky-actions { margin-bottom:18px; }
.code { font-family:ui-monospace, SFMono-Regular, Menlo, monospace; }
/* Larger, lighter export button styling */
.btn-export { background:#3a4860; border:1px solid #2f3b52; color:var(--text); padding:10px 16px; border-radius:10px; cursor:pointer; font-weight:700; font-size:13px; }
.btn-export:hover { background:#445571; border-color:#3a4860; }
/* Report slicers + sub-tabs */
.report-slicers { display:flex; flex-wrap:wrap; gap:12px; padding:10px 12px; background:var(--panel); border:1px solid #222c3a; border-radius:10px; margin-bottom:14px; }
.slicer { display:flex; flex-direction:column; gap:6px; }
.slicer label { font-size:11px; letter-spacing:.5px; color:var(--text-dim); font-weight:600; }
.slicer select { min-width:180px; background:#0f1520; border:1px solid #2a3343; color:var(--text); padding:8px 10px; border-radius:8px; font-weight:600; }
.slicer select[multiple] { min-width:220px; min-height:90px; }
/* Dropdown slicers (PWHL-like) */
.slicer .dropdown { position:relative; }
.slicer .dropdown-btn { min-width:180px; background:#0f1520; border:1px solid #2a3343; color:var(--text); padding:8px 10px; border-radius:8px; font-weight:600; display:flex; align-items:center; justify-content:space-between; gap:10px; cursor:pointer; }
.slicer .dropdown-btn:after { content:''; width:0; height:0; border-left:5px solid transparent; border-right:5px solid transparent; border-top:6px solid rgba(255,255,255,0.8); margin-left:auto; }
.slicer .dropdown-menu { position:absolute; top:calc(100% + 6px); left:0; background:#0b1220; border:1px solid #2a3343; border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,.4); padding:8px; z-index:40; min-width:240px; max-height:280px; overflow:auto; }
.slicer .dropdown-item { display:flex; align-items:center; gap:8px; padding:6px 6px; border-radius:6px; }
.slicer .dropdown-item:hover { background:rgba(255,255,255,.05); }
.slicer .dropdown-item input { accent-color: var(--accent, #53b3ff); }
.slicer .hidden-select { display:none !important; }
/* Always render radio circles as filled (visual parity) */
.slicer .dropdown-item input[type=radio]{
  appearance:none; -webkit-appearance:none; -moz-appearance:none;
  width:14px; height:14px; border-radius:50%;
  border:1px solid rgba(255,255,255,.55);
  background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.95) 0 45%, rgba(255,255,255,0.95) 45% 100%);
}
/* Selected row highlight (for single-select like Team) */
/* removed selected-row highlight per design */
/* Tools row for multi dropdowns */
.slicer .dropdown-tools { position:sticky; top:0; background:#0b1220; padding:4px 6px 6px; display:flex; justify-content:flex-end; gap:8px; z-index:1; }
.slicer .dropdown-tools .link-btn { background:transparent; color:var(--text); opacity:.85; border:none; font-size:12px; padding:4px 6px; cursor:pointer; border-radius:6px; }
.slicer .dropdown-tools .link-btn:hover { background:rgba(255,255,255,.06); }
.report-subtabs { display:flex; gap:8px; border-bottom:1px solid #222c3a; margin-top:8px; }
.report-subtabs button { background:none; border:none; padding:10px 10px; font-weight:700; color:var(--text-dim); cursor:pointer; position:relative; }
.report-subtabs button.active { color:var(--text); }
.report-subtabs button.active::after { content:""; position:absolute; left:8px; right:8px; bottom:-1px; height:3px; background:var(--accent); border-radius:3px; }
/* Rink layout */
.report-rink-row { display:grid; grid-template-columns:1fr 260px 1fr; gap:14px; margin-top:10px; align-items:stretch; }
.report-rink-row > .zone, .report-rink-row > .kpi-stack { height:100%; }
.zone { background:var(--panel); border:1px solid #222c3a; border-radius:10px; padding:8px; display:flex; flex-direction:column; }
.zone h4 { margin:6px 0 8px; font-size:14px; font-weight:700; color:var(--text-dim); text-align:center; }
.zone-wrap { position:relative; width:100%; max-width:620px; margin:0 auto; aspect-ratio:75/85; border-radius:10px; overflow:hidden; background:#0d1117; }
.zone-wrap canvas { position:absolute; inset:0; width:100%; height:100%; }
@media (max-width: 1100px){ .report-rink-row { grid-template-columns:1fr; } }
.kpi-stack{ display:flex; flex-direction:column; height:100%; background:var(--panel); border:1px solid #222c3a; border-radius:10px; padding:8px; }
.kpi-card { background:#1a212e; border:1px solid #222c3a; border-radius:12px; padding:10px; display:flex; flex-direction:column; gap:8px; }
.kpi-card h5{ margin:0; font-size:15px; font-weight:800; text-align:center; color:#d6d3e9; }
.kpi-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; }
.kpi { background:#111827; border:1px solid rgba(255,255,255,0.08); border-radius:10px; padding:8px 6px; text-align:center; }
.kpi.middle{ background:#e6eefc; color:#111; border-color:#e6eefc; }
.kpi .lbl{ font-size:10px; color:var(--text-dim); letter-spacing:.07em; text-transform:uppercase; font-weight:700; }
.kpi.middle .lbl{ color:#23324d; }
.kpi .val{ font-size:18px; font-weight:800; }
.legend { background:transparent; border:none; padding:0; display:flex; flex-wrap:nowrap; align-items:center; justify-content:center; gap:14px; margin-top:30px; }
.legend-row{ display:flex; gap:8px; align-items:center; font-size:12px; color:var(--text); }
.legend-row canvas{ width:28px; height:28px; background:transparent; }
/* Shot tooltip */
.shot-tooltip { position:fixed; pointer-events:none; z-index:1000; background:#0b1220; border:1px solid #2a3343; color:var(--text); border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,.35); padding:8px 10px; display:none; max-width:280px; }
.shot-tooltip .row { display:flex; align-items:center; gap:10px; }
.shot-tooltip img { width:42px; height:42px; border-radius:8px; object-fit:cover; background:#0d1117; }
.shot-tooltip .meta { display:flex; flex-direction:column; gap:2px; font-size:12px; }
.shot-tooltip .name { font-weight:700; font-size:13px; }
.team-logo { width:34px; height:34px; object-fit:contain; filter:drop-shadow(0 1px 2px rgba(0,0,0,.5)); }
</style>
{% endblock %}
{% block content %}
<div class="game-header">
  <button onclick="window.location.href='/'" style="background:var(--panel-alt); border:1px solid #2a3343; color:var(--text); padding:8px 14px; border-radius:8px; cursor:pointer; font-weight:600; font-size:13px; margin-bottom:14px;">‚Üê Back to Schedule</button>
  <h2 id="gameTitle">Loading...</h2>
  <div class="subline" id="gameMeta"></div>
  <div class="final-line" id="gameFinal" style="margin-top:4px;"></div>
</div>
<div class="game-tabs">
  <button data-tab="report" class="active">Report</button>
  <button data-tab="lineups">Lineups</button>
  <button data-tab="pbp">Play-by-Play</button>
  <button data-tab="shifts">Shifts</button>
</div>
<div id="tabContent"></div>
<script id="teams-data" type="application/json">{{ teams|tojson|safe }}</script>
{% endblock %}
{% block scripts %}
<script>
const GAME_ID = "{{ game_id }}";
const tabContent = document.getElementById('tabContent');
const tabs = document.querySelectorAll('.game-tabs button');
let boxscoreData, pbpData, shiftsData; let headerInitialized=false;

tabs.forEach(btn=> btn.addEventListener('click', ()=>{ tabs.forEach(b=> b.classList.remove('active')); btn.classList.add('active'); showTab(btn.dataset.tab); }));

function showTab(tab){
  if(tab==='report') renderReport();
  else if(tab==='lineups') renderLineups();
  else if(tab==='pbp') renderPBP();
  else if(tab==='shifts') renderShifts();
}

async function ensureData(){
  if(!boxscoreData){ boxscoreData = await fetchJson(`/api/game/${GAME_ID}/boxscore?force=1`); if(!headerInitialized) buildHeader(); }
  if(!pbpData){ pbpData = await fetchJson(`/api/game/${GAME_ID}/play-by-play?force=1`); }
  if(!shiftsData){ shiftsData = await fetchJson(`/api/game/${GAME_ID}/shifts?force=1`); }
}

// Small live refresher: if the game is LIVE, periodic refresh to keep pages updated
async function maybeAutoRefresh(){
  try{
    const bs = await fetchJson(`/api/game/${GAME_ID}/boxscore?force=1`);
    const state = String(bs.gameState || bs.gameStatus || '').toUpperCase();
    if(state === 'LIVE' || state === 'INPROGRESS' || state === 'SCHEDULED' || state === 'PREVIEW'){
      // refresh pbp and shifts live
      pbpData = await fetchJson(`/api/game/${GAME_ID}/play-by-play?force=1`);
      shiftsData = await fetchJson(`/api/game/${GAME_ID}/shifts?force=1`);
      // If currently viewing pbp or shifts or report, trigger re-render
      const active = document.querySelector('.game-tabs button.active')?.dataset.tab;
      if(active==='pbp') renderPBP();
      else if(active==='shifts') renderShifts();
      else if(active==='report') renderReport();
    }
  }catch(e){}
}
setInterval(maybeAutoRefresh, 30000);
</script>
{% endblock %}
