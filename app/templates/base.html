<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NHL Analytics</title>
  <link rel="icon" type="image/png" href="/favicon.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0d0f16; --panel:#141826; --panel-alt:#1c2233; --text:#e6e8ec; --text-dim:#9aa4b1; --accent:#4da3ff; --value-text:#f1f5f9; }
    body { margin:0; font-family:Inter, system-ui, sans-serif; background:linear-gradient(160deg,#05060a,#0f121a); color:var(--text); }
    .app-shell { display:grid; grid-template-columns:260px 1fr; min-height:100vh; min-width:0; }
    .app-shell > div { min-width:0; }
  aside { background:radial-gradient(circle at 30% 20%, var(--panel), #0b0e15); padding:16px 8px 20px; border-right:1px solid #232a3a; }
  header { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:14px; }
  .hdr-left{ display:flex; align-items:center; gap:10px; min-width:0; }
  header img.logo { height:54px; filter:drop-shadow(0 0 4px #000); flex:0 0 auto; }
  h1 { font-size:24px; letter-spacing:.8px; font-weight:650; margin:0; }
  .hdr-title{ min-width:0; }
  .hdr-actions{ display:none; gap:8px; align-items:center; }
  .icon-btn{ background:var(--panel-alt); border:1px solid #2a3142; color:var(--value-text, var(--text)); width:40px; height:40px; border-radius:10px; display:inline-flex; align-items:center; justify-content:center; cursor:pointer; }
  .icon-btn:active{ transform:translateY(1px); }
  .icon{ width:20px; height:20px; display:block; }
  .mobile-summary{ display:none; font-size:12px; color:var(--text-dim); font-weight:650; letter-spacing:.2px; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  .mobile-menu{ display:none; border:1px solid #232a3a; border-radius:12px; background:rgba(255,255,255,0.02); overflow:hidden; }
  .mobile-menu a{ display:block; padding:12px 12px; text-decoration:none; color:var(--text); font-weight:750; letter-spacing:.2px; border-bottom:1px solid #232a3a; }
  .mobile-menu a:last-child{ border-bottom:none; }
  .mobile-menu a.active{ background:rgba(255,255,255,0.03); outline:2px solid rgba(77,163,255,0.20); outline-offset:-2px; }

  .filters-shell{ margin-top:12px; }
  .filters-hd{ display:none; align-items:center; justify-content:space-between; gap:10px; padding:10px 10px; border:1px solid #232a3a; border-radius:12px; background:rgba(255,255,255,0.02); }
  .filters-hd .ttl{ font-size:12px; letter-spacing:1px; text-transform:uppercase; color:var(--text-dim); font-weight:900; }
  .filters-hd .right{ display:flex; align-items:center; gap:10px; min-width:0; }
  .filters-hd .sum{ font-size:12px; color:var(--text); opacity:.92; font-weight:750; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:56vw; }
  .filters-toggle{ background:transparent; border:1px solid #2a3142; color:var(--text); padding:7px 10px; border-radius:10px; font-weight:800; letter-spacing:.2px; cursor:pointer; }

  nav.tabs { display:flex; gap:36px; padding:0 34px; height:46px; align-items:flex-end; border-bottom:1px solid #1f2734; background:#0e121b; position:sticky; top:0; z-index:30; }
  nav.tabs a { position:relative; top:10px; padding:12px 6px 18px; font-size:16px; font-weight:600; color:var(--text-dim); text-decoration:none; letter-spacing:.6px; }
  nav.tabs a.active, nav.tabs a:hover { color:var(--text); }
  nav.tabs a.active::after { content:""; position:absolute; left:0; right:0; bottom:10px; height:4px; border-radius:4px; background:var(--accent); box-shadow:0 0 8px -1px var(--accent); }
    .filters { display:flex; flex-direction:column; gap:18px; }
    label { display:flex; flex-direction:column; font-size:12px; gap:6px; text-transform:uppercase; letter-spacing:.9px; color:var(--text-dim); font-weight:600; }
  select { background:var(--panel-alt); color:var(--value-text, var(--text)); border:1px solid #2a3142; padding:10px 12px; border-radius:8px; font-size:14px; font-weight:500; appearance:none; -webkit-appearance:none; -moz-appearance:none; background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%239aa4b1'%3E%3Cpath d='M7 10l5 5 5-5'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 12px center; background-size:18px; padding-right:42px; }
  select:focus { outline:2px solid var(--accent); outline-offset:1px; }
  input[type="number"], input[type="text"] { background:var(--panel-alt); color:var(--value-text, var(--text)); border:1px solid #2a3142; padding:10px 12px; border-radius:8px; font-size:14px; font-weight:500; }
  input[type="number"]:focus, input[type="text"]:focus { outline:2px solid var(--accent); outline-offset:1px; }
  label.checkbox-row { flex-direction:row; align-items:center; font-size:11px; letter-spacing:.8px; text-transform:uppercase; gap:8px; font-weight:600; }
  label.checkbox-row span { position:relative; top:1px; }
  label.checkbox-row input { accent-color:var(--accent); width:16px; height:16px; }
  main { padding:26px 42px 24px; min-width:0; }
    .calendar-grid { width:100%; display:grid; grid-template-columns:repeat(7, 1fr); gap:6px; }
    .month-header { display:flex; justify-content:space-between; align-items:center; margin:6px 0 20px; }
    .month-title { font-size:28px; font-weight:600; letter-spacing:1px; }
    .day-names { display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin-bottom:4px; }
    .day-names div { text-align:center; font-size:11px; font-weight:600; letter-spacing:1px; text-transform:uppercase; color:var(--text-dim); }
    .game-tile { position:relative; aspect-ratio:7/6; border-radius:10px; padding:6px 6px 4px; display:flex; flex-direction:column; justify-content:space-between; overflow:hidden; background:#1a2231; border:1px solid #1d2735; box-shadow:0 2px 4px -2px rgba(0,0,0,.6); }
    .game-tile.empty { background:transparent; border:none; box-shadow:none; }
    .game-date { font-size:11px; font-weight:600; letter-spacing:.5px; color:var(--text-dim); }
    .matchup { font-size:18px; font-weight:700; line-height:1.15; letter-spacing:.5px; }
    .home { outline:2px solid rgba(255,255,255,.08); }
    .legend { display:flex; gap:16px; font-size:12px; margin-top:18px; color:var(--text-dim); }
    .legend span { display:inline-flex; align-items:center; gap:6px; }
    .dot { width:14px; height:14px; border-radius:4px; background:var(--panel-alt); box-shadow:0 0 0 1px #222d3d; }
    footer { margin-top:60px; font-size:12px; color:#5b6472; }
    .status-chip { position:absolute; bottom:4px; right:6px; font-size:10px; font-weight:600; letter-spacing:.5px; background:rgba(0,0,0,.35); padding:3px 6px; border-radius:5px; backdrop-filter:blur(4px); }
    .skeleton { background:linear-gradient(100deg,#1d2431,#2a3344 40%,#1d2431 60%); background-size:200% 100%; animation:shimmer 1.2s linear infinite; }
    @keyframes shimmer { to { background-position:-200% 0; } }
    /* Branding block */
  .brand { display:flex; flex-direction:column; align-items:center; gap:20px; margin-top:8px; padding-top:8px; border-top:1px solid #232a3a; }
  .brand a { text-decoration:none; }
  .brand-logo { height:100px; width:auto; object-fit:contain; filter:drop-shadow(0 0 8px rgba(0,0,0,.7)); }
  .brand-by { font-size:16px; color:var(--text-dim); font-weight:600; letter-spacing:.6px; font-style:italic; margin-top:-15px; }

  @media (max-width: 980px){
    .app-shell{ grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
    aside{ border-right:none; border-bottom:1px solid #232a3a; padding:12px 10px 12px; position:sticky; top:0; z-index:60; }
    main{ padding:18px 12px 18px; }
    nav.tabs{ display:none; }
    .hdr-actions{ display:flex; }
    header img.logo{ height:44px; }
    h1{ font-size:18px; }
    .mobile-summary{ display:block; }
    .filters-hd{ display:flex; }
    .filters-hd{ cursor:pointer; user-select:none; }
    .mobile-menu{ display:block; margin-top:10px; }
    .filters{ margin-top:10px; }
    body.filters-collapsed .filters{ display:none; }
  }
  </style>
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-LQY14MGCDV"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-LQY14MGCDV');
  </script>
  {% block head %}{% endblock %}
</head>
<body>
  <div class="app-shell">
    <aside>
      <header>
        <div class="hdr-left">
          <img class="logo" src="https://assets.nhle.com/logos/nhl/svg/NHL_dark.svg" alt="NHL" />
          <div class="hdr-title">
            <h1>NHL Analytics</h1>
            <div id="mobileSlicerSummary" class="mobile-summary"></div>
          </div>
        </div>
        <div class="hdr-actions" aria-label="Mobile controls">
          <button id="btnMobileMenu" class="icon-btn" type="button" aria-label="Menu" aria-expanded="false">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
              <path d="M4 6h16"/><path d="M4 12h16"/><path d="M4 18h16"/>
            </svg>
          </button>
          <button id="btnMobileFilters" class="icon-btn" type="button" aria-label="Filters" aria-expanded="true">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4 6h16"/><path d="M7 12h10"/><path d="M10 18h4"/>
            </svg>
          </button>
        </div>
      </header>

      <div id="mobileMenuPanel" class="mobile-menu" hidden>
        <a href="/" class="{% if active_tab=='Schedule' %}active{% endif %}">Schedule</a>
        <a href="/standings" class="{% if active_tab=='Standings' %}active{% endif %}">Standings</a>
        <a href="/live" class="{% if active_tab=='Live Games' %}active{% endif %}">Live Games</a>
        <a href="/projections" class="{% if active_tab=='Game Projections' %}active{% endif %}">Game Projections</a>
        <a href="/skaters" class="{% if active_tab=='Skaters' %}active{% endif %}">Skaters</a>
        <a href="/goalies" class="{% if active_tab=='Goalies' %}active{% endif %}">Goalies</a>
        <a href="/teams" class="{% if active_tab=='Teams' %}active{% endif %}">Teams</a>
      </div>

      <div class="filters-shell">
        <div class="filters-hd">
          <div class="ttl">Slicers</div>
          <div class="right">
            <div id="filtersSummary" class="sum"></div>
          </div>
        </div>
      <div class="filters">
        <label>Team
          <select id="teamSelect"></select>
        </label>
        <label>Season
          <select id="seasonSelect"></select>
        </label>
        {% block extra_filters %}{% endblock %}
        {% if show_season_state %}
        <label>Season State
          <select id="seasonStateSelect">
            <option value="2" selected>Regular Season</option>
            <option value="3">Playoffs</option>
          </select>
        </label>
        {% endif %}
        {% if show_include_historic is not defined or show_include_historic %}
        <label class="checkbox-row"><input type="checkbox" id="includeHistoric" /> <span>Include Historic Teams</span></label>
        {% endif %}
        {% if active_tab in ['Schedule','Standings','Live Games'] %}
        <div class="brand">
          <a href="https://hockey-statistics.com/" target="_blank" rel="noopener">
            <img class="brand-logo" src="{{ url_for('static', filename='Logo.png') }}" alt="Hockey Statistics" />
          </a>
          <div class="brand-by">App by Hockey Skytte</div>
        </div>
        {% endif %}
      </div>
      </div>
    </aside>
    <div>
      <nav class="tabs">
  <a href="/" class="{% if active_tab=='Schedule' %}active{% endif %}">Schedule</a>
  <a href="/standings" class="{% if active_tab=='Standings' %}active{% endif %}">Standings</a>
  <a href="/live" class="{% if active_tab=='Live Games' %}active{% endif %}">Live Games</a>
    <a href="/projections" class="{% if active_tab=='Game Projections' %}active{% endif %}">Game Projections</a>
        <a href="/skaters" class="{% if active_tab=='Skaters' %}active{% endif %}">Skaters</a>
        <a href="/goalies" class="{% if active_tab=='Goalies' %}active{% endif %}">Goalies</a>
        <a href="/teams" class="{% if active_tab=='Teams' %}active{% endif %}">Teams</a>
        <a href="#" class="{% if active_tab=='About' %}active{% endif %}">About</a>
      </nav>
      <main>
        {% block content %}{% endblock %}
      </main>
    </div>
  </div>
  <script>
  (function(){
    if(window.__filtersInit) return; window.__filtersInit = true;
    const teamSelect = document.getElementById('teamSelect');
    const seasonSelect = document.getElementById('seasonSelect');
    const seasonStateSelect = document.getElementById('seasonStateSelect');
    const includeHistoric = document.getElementById('includeHistoric');
    const btnMobileMenu = document.getElementById('btnMobileMenu');
    const btnMobileFilters = document.getElementById('btnMobileFilters');
    const mobileMenuPanel = document.getElementById('mobileMenuPanel');
    const filtersHd = document.querySelector('.filters-hd');
    const filtersSummary = document.getElementById('filtersSummary');
    const mobileSlicerSummary = document.getElementById('mobileSlicerSummary');
    if(!teamSelect || !seasonSelect) return;

    // Global slicers: Team + Season must stay consistent across pages.
    // Priority: URL params (if present) -> localStorage.
    let __urlTeam = null;
    let __urlSeason = null;
    try{
      const sp = new URLSearchParams(window.location.search || '');
      const t = String(sp.get('team') || '').trim();
      const s = String(sp.get('season') || '').trim();
      __urlTeam = t || null;
      __urlSeason = s || null;
      if(t) localStorage.setItem('team', t);
      if(s) localStorage.setItem('season', s);
    }catch(_){/*noop*/}

    function syncUrlAndNav(){
      try{
        const team = String(teamSelect.value||'').trim();
        const seasonRaw = String(seasonSelect.value||'').trim();
        const season = /^\d{8}$/.test(seasonRaw) ? seasonRaw : '';

        const u = new URL(window.location.href);
        if(team) u.searchParams.set('team', team);
        if(season) u.searchParams.set('season', season);
        else u.searchParams.delete('season');
        history.replaceState({}, '', u);

        const links = Array.from(document.querySelectorAll('nav.tabs a[href^="/"], #mobileMenuPanel a[href^="/"]'));
        links.forEach(a=>{
          const href = a.getAttribute('href');
          if(!href || href === '#') return;
          const basePath = href.split('?')[0];
          const nu = new URL(basePath, window.location.origin);
          if(team) nu.searchParams.set('team', team);
          if(season) nu.searchParams.set('season', season);
          else nu.searchParams.delete('season');
          a.setAttribute('href', nu.pathname + nu.search);
        });
      }catch(_){/*noop*/}
    }

    function updateSlicerSummary(){
      try{
        const team = String(teamSelect?.value||'').trim();
        const seasonRaw = String(seasonSelect?.value||'').trim();
        const season = /^\d{8}$/.test(seasonRaw) ? seasonRaw : '';
        const label = [team||'—', season||'—'].join(' · ');
        if(filtersSummary) filtersSummary.textContent = label;
        if(mobileSlicerSummary) mobileSlicerSummary.textContent = label;
      }catch(_){/*noop*/}
    }

    function setFiltersCollapsed(collapsed){
      try{
        document.body.classList.toggle('filters-collapsed', !!collapsed);
        localStorage.setItem('globalFiltersCollapsed_v1', collapsed ? '1' : '0');
        if(btnMobileFilters) btnMobileFilters.setAttribute('aria-expanded', collapsed ? 'false' : 'true');
      }catch(_){/*noop*/}
    }

    function isMobile(){
      try{ return window.matchMedia && window.matchMedia('(max-width: 980px)').matches; }catch(_){ return false; }
    }

    function closeMobileMenu(){
      try{
        if(!mobileMenuPanel) return;
        mobileMenuPanel.hidden = true;
        btnMobileMenu && btnMobileMenu.setAttribute('aria-expanded', 'false');
      }catch(_){/*noop*/}
    }

    // Mobile controls
    try{
      btnMobileMenu && btnMobileMenu.addEventListener('click', ()=>{
        if(!mobileMenuPanel) return;
        const open = !mobileMenuPanel.hidden;
        mobileMenuPanel.hidden = open;
        btnMobileMenu.setAttribute('aria-expanded', open ? 'false' : 'true');
      });
      btnMobileFilters && btnMobileFilters.addEventListener('click', ()=>{
        const collapsed = document.body.classList.contains('filters-collapsed');
        setFiltersCollapsed(!collapsed);
      });
      filtersHd && filtersHd.addEventListener('click', ()=>{
        const collapsed = document.body.classList.contains('filters-collapsed');
        setFiltersCollapsed(!collapsed);
      });
      // Close menu when navigating
      mobileMenuPanel && mobileMenuPanel.addEventListener('click', (e)=>{
        const a = e.target && e.target.closest ? e.target.closest('a') : null;
        if(a) closeMobileMenu();
      });
      // Close menu on outside click (mobile only)
      document.addEventListener('click', (e)=>{
        if(!isMobile()) return;
        if(!mobileMenuPanel || mobileMenuPanel.hidden) return;
        const t = e.target;
        if(btnMobileMenu && btnMobileMenu.contains(t)) return;
        if(mobileMenuPanel.contains(t)) return;
        closeMobileMenu();
      });
    }catch(_){/*noop*/}
    function parseTeams(){
      const tag = document.getElementById('teams-data');
      if(!tag) return [];
      try { return JSON.parse(tag.textContent); } catch(e){ return []; }
    }
    const teamsData = parseTeams();
    if(typeof lightenDarken==='undefined'){
      window.lightenDarken = function(hex, factor){ hex=hex.replace('#',''); let r=parseInt(hex.substring(0,2),16), g=parseInt(hex.substring(2,4),16), b=parseInt(hex.substring(4,6),16); if(factor>1){r=r+(255-r)*(factor-1); g=g+(255-g)*(factor-1); b=b+(255-b)*(factor-1);} else {r*=factor; g*=factor; b*=factor;} r=Math.min(255,Math.max(0,Math.round(r))); g=Math.min(255,Math.max(0,Math.round(g))); b=Math.min(255,Math.max(0,Math.round(b))); return '#' + r.toString(16).padStart(2,'0') + g.toString(16).padStart(2,'0') + b.toString(16).padStart(2,'0'); };
    }
    if(typeof isLight==='undefined'){
      window.isLight = function(hex){ hex=hex.replace('#',''); let r=parseInt(hex.substring(0,2),16), g=parseInt(hex.substring(2,4),16), b=parseInt(hex.substring(4,6),16); return (0.299*r+0.587*g+0.114*b)>155; };
    }
    function setTheme(){
      const teamRow = teamsData.find(t=>t.Team===teamSelect.value);
      if(!teamRow) return;
      const base = teamRow.Color || '#1d2735';
      const light = lightenDarken(base, isLight(base)?0.55:1.4);
      const dark1 = lightenDarken(base, isLight(base)?0.35:0.75);
      const dark2 = lightenDarken(base, isLight(base)?0.25:0.55);
      const root = document.documentElement;
      root.style.setProperty('--accent', light);
      root.style.setProperty('--bg', dark2);
      root.style.setProperty('--panel', dark1);
      root.style.setProperty('--panel-alt', base);
      const valueColor = isLight(base)? '#0f141b' : '#f1f5f9';
      root.style.setProperty('--value-text', valueColor);
      const viewModeSelect = document.getElementById('viewMode');
      const playerSelect = document.getElementById('playerSelect');
      [teamSelect, seasonSelect, seasonStateSelect, viewModeSelect, playerSelect].filter(Boolean).forEach(sel=> sel.style.color = valueColor);
    }
    function populateTeams(){
      const showHistoric = includeHistoric && includeHistoric.checked;
      const list = teamsData.filter(t=> showHistoric || String(t.Active)==='1');
      list.sort((a,b)=>a.Name.localeCompare(b.Name));
      const prev = teamSelect.value || __urlTeam || localStorage.getItem('team');
      teamSelect.innerHTML = list.map(t=>`<option value="${t.Team}">${t.Name}</option>`).join('');
      if(prev && list.find(t=>t.Team===prev)) teamSelect.value = prev; else if(list.length) teamSelect.value = list[0].Team;
      localStorage.setItem('team', teamSelect.value);
      __urlTeam = null;
      updateSlicerSummary();
    }
    async function loadSeasons(){
      const team = teamSelect.value; if(!team) return;
      seasonSelect.innerHTML = '<option>Loading...</option>';
      try {
        const r = await fetch(`/api/seasons/${team}`); const meta = await r.json();
        window.__seasonMeta = meta;
        seasonSelect.innerHTML = meta.map(o=>`<option value="${o.season}">${o.season}</option>`).join('');
        const saved = __urlSeason || localStorage.getItem('season');
        if(saved && meta.find(m=>String(m.season)===saved)) seasonSelect.value = saved; else if(meta.length) seasonSelect.value = meta[0].season;
        __urlSeason = null;
        handleSeasonStateAvailability();
        syncUrlAndNav();
        updateSlicerSummary();
      } catch(e){ seasonSelect.innerHTML='<option>Error</option>'; }
    }
    function handleSeasonStateAvailability(){
      if(!seasonStateSelect) return; const val = parseInt(seasonSelect.value,10); const meta = (window.__seasonMeta||[]).find(m=>m.season===val); const playoffs = meta && Array.isArray(meta.gameTypes) && meta.gameTypes.map(String).includes('3');
      for(const opt of seasonStateSelect.options){ if(opt.value==='3'){ opt.disabled = !playoffs; if(!playoffs && seasonStateSelect.value==='3') seasonStateSelect.value='2'; }}
      triggerDataReload();
    }
    function triggerDataReload(){
      if(typeof loadSchedule==='function') loadSchedule();
      if(typeof loadStandings==='function') loadStandings();
    }
    // Event listeners
    teamSelect.addEventListener('change', ()=>{ localStorage.setItem('team', teamSelect.value); setTheme(); syncUrlAndNav(); updateSlicerSummary(); loadSeasons(); });
    seasonSelect.addEventListener('change', ()=>{ localStorage.setItem('season', seasonSelect.value); syncUrlAndNav(); updateSlicerSummary(); handleSeasonStateAvailability(); triggerDataReload(); });
    if(seasonStateSelect) seasonStateSelect.addEventListener('change', ()=> triggerDataReload());
    if(includeHistoric) includeHistoric.addEventListener('change', ()=>{ populateTeams(); setTheme(); loadSeasons(); });
    // Init
    // Restore collapsed state (mobile only)
    try{
      const wantCollapsed = localStorage.getItem('globalFiltersCollapsed_v1') === '1';
      setFiltersCollapsed(isMobile() ? wantCollapsed : false);
    }catch(_){/*noop*/}

    populateTeams(); setTheme(); loadSeasons(); syncUrlAndNav(); updateSlicerSummary();
  })();
  </script>
  {% block scripts %}{% endblock %}
</body>
</html>