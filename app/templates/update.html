<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Update Data & Lineups</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; }
        .section { margin-bottom: 2em; }
        label { display: block; margin-bottom: 0.5em; }
        input[type="date"] { margin-right: 1em; }
        button { margin-top: 1em; }
        .output { margin-top: 1em; background: #f4f4f4; padding: 1em; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>Update Scripts</h1>
    <div class="section">
        <h2>Run update_data.py</h2>
        <form id="update-data-form">
            <label for="update-date">Date (YYYY-MM-DD):</label>
            <input type="date" id="update-date" name="date" required>
            <div style="margin-top:0.5em">
                <label for="season">Season (table suffix, e.g. 20252026):</label>
                <input type="text" id="season" name="season" value="20252026" style="width: 10em;">
            </div>
            <div style="margin-top:0.5em">
                <label><input type="checkbox" id="export-db" checked> Export to MySQL</label>
                <label style="margin-left:1em"><input type="checkbox" id="replace-date" checked> Replace rows for date</label>
                <label style="margin-left:1em"><input type="checkbox" id="projections-to-sheets" checked> Write player projections to Google Sheets (Sheets3)</label>
            </div>
            <button type="submit">Run update_data.py</button>
            <div style="margin-top:0.5em; font-size: 0.9em; color: #444;">
                Requires env vars on the machine running Flask: <code>GOOGLE_SERVICE_ACCOUNT_JSON_B64</code> (or <code>GOOGLE_SERVICE_ACCOUNT_JSON</code>), and optionally <code>PROJECTIONS_SHEET_ID</code> / <code>PROJECTIONS_WORKSHEET</code>.
            </div>
        </form>
        <div id="update-data-output" class="output"></div>
    </div>
    <div class="section">
        <h2>Run lineups.py (All Teams)</h2>
        <button id="run-lineups">Run lineups.py --all</button>
        <div id="lineups-output" class="output"></div>
    </div>
    <script>
    async function pollJob(jobId, outputEl) {
        try {
            const res = await fetch(`/admin/job/${jobId}`);
            if (!res.ok) {
                outputEl.textContent = `Error fetching job status (${res.status})`;
                return;
            }
            const data = await res.json();
            if (data.status === 'running') {
                outputEl.textContent = 'Running...';
                setTimeout(() => pollJob(jobId, outputEl), 1500);
            } else {
                outputEl.textContent = data.output || `Status: ${data.status}`;
            }
        } catch (err) {
            outputEl.textContent = `Error: ${err}`;
        }
    }

    document.getElementById('update-data-form').onsubmit = async function(e) {
        e.preventDefault();
        const date = document.getElementById('update-date').value;
        const season = document.getElementById('season').value;
        const exportDb = document.getElementById('export-db').checked;
        const replaceDate = document.getElementById('replace-date').checked;
        const projectionsToSheets = document.getElementById('projections-to-sheets').checked;
        const output = document.getElementById('update-data-output');
        output.textContent = 'Starting...';
        try {
            const res = await fetch('/admin/run-update-data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    date,
                    season,
                    export: exportDb,
                    replace_date: replaceDate,
                    projections_to_sheets: projectionsToSheets,
                    projections_worksheet: 'Sheets3'
                })
            });
            if (!res.ok) {
                const txt = await res.text();
                output.textContent = `Error (${res.status}): ${txt}`;
                return;
            }
            const data = await res.json();
            if (data.jobId) {
                pollJob(data.jobId, output);
            } else {
                output.textContent = data.output || data.error || 'Done.';
            }
        } catch (err) {
            output.textContent = `Error: ${err}`;
        }
    };
    document.getElementById('run-lineups').onclick = async function() {
        const output = document.getElementById('lineups-output');
        output.textContent = 'Starting...';
        try {
            const res = await fetch('/admin/run-lineups', { method: 'POST' });
            if (!res.ok) {
                const txt = await res.text();
                output.textContent = `Error (${res.status}): ${txt}`;
                return;
            }
            const data = await res.json();
            if (data.jobId) {
                pollJob(data.jobId, output);
            } else {
                output.textContent = data.output || data.error || 'Done.';
            }
        } catch (err) {
            output.textContent = `Error: ${err}`;
        }
    };
    </script>
</body>
</html>
